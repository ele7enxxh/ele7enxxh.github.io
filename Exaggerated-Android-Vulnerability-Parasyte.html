<!DOCTYPE html>
<html lang="zh-Hans">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="被夸大的安卓漏洞“寄生兽”"/>







  <link rel="alternate" href="/atom.xml" title="Ele7enxxh's Blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.png?v=2.2.x" />



<link rel="canonical" href="http://ele7enxxh.com/Exaggerated-Android-Vulnerability-Parasyte.html"/>


<meta name="description" content="本文主要吐槽了360爆出的寄生兽漏洞，不得不说这个名字取得也真是不靠谱。">
<meta property="og:type" content="article">
<meta property="og:title" content="被夸大的安卓漏洞“寄生兽”">
<meta property="og:url" content="http://ele7enxxh.com/Exaggerated-Android-Vulnerability-Parasyte.html">
<meta property="og:site_name" content="Ele7enxxh's Blog">
<meta property="og:description" content="本文主要吐槽了360爆出的寄生兽漏洞，不得不说这个名字取得也真是不靠谱。">
<meta property="og:image" content="http://ele7enxxh.com/images/Exaggerated-Android-Vulnerability-Parasyte_1.jpg">
<meta property="og:updated_time" content="2016-03-23T06:30:47.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="被夸大的安卓漏洞“寄生兽”">
<meta name="twitter:description" content="本文主要吐槽了360爆出的寄生兽漏洞，不得不说这个名字取得也真是不靠谱。">
<meta name="twitter:image" content="http://ele7enxxh.com/images/Exaggerated-Android-Vulnerability-Parasyte_1.jpg">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.2.x" />



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />





<script>
  var CONFIG = {
    search: true,
    searchPath: "/search.xml",
    fancybox: true,
    toc: true,
  }
</script>




  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?e9925f9b47e12674b38b04ce3cde49e6";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




    <title> 被夸大的安卓漏洞“寄生兽” · Ele7enxxh's Blog </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Ele7enxxh's Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            Home
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            Archives
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Ele7enxxh's Blog</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              Home
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              Archives
            
          </a>
        </li>
      
      
        <li class="menu-search">
          <form>
            <i class="iconfont icon-search" id="open-search"></i>
            <input type="text" class="search-input" id="search-input" />
            <i class="iconfont icon-close" id="close-search"></i>
          </form>
        </li>
      
    </ul>
  
</nav>
      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          被夸大的安卓漏洞“寄生兽”
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          Jul 1, 2015
        </span>
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#细节"><span class="toc-text">细节</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#真相"><span class="toc-text">真相</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#防范与修复"><span class="toc-text">防范与修复</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#其他"><span class="toc-text">其他</span></a></li></ol>
    </div>
  </div>


    <div class="post-content">
      
        <p>本文主要吐槽了360爆出的寄生兽漏洞，不得不说这个名字取得也真是不靠谱。<a id="more"></a></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>昨天下午360安全播报把我吓了一跳，这个洞的描述简直碉堡：</p>
<blockquote>
<p>6月29日，360手机安全研究团队 vulpecker team，向补天漏洞响应平台提交了其发现的安卓app新型通用安全漏洞“寄生兽”，这个漏洞影响市面上数以千万的APP，众多流行APP也包括在内，影响范围包括百度、腾讯、阿里等众多厂商的移动产品。</p>
<p>利用该漏洞的攻击者可以直接在用户手机中植入木马，盗取用户的短信照片等个人隐私，盗取银行、支付宝等账号密码等。目前补天已经将相关详情通知给各大安全应急响应中心，并敦请厂商收到详情及时自查，如果自家app存在相关安全问题，需及时修复。</p>
</blockquote>
<p>再来看一下补天的漏洞描述：</p>
<blockquote>
<p>360 vulpecker team发现了安卓app一种新型的通用安全漏洞，这个漏洞影响市面上众多流行APP的远程代码执行漏洞，影响范围包括百度、腾讯、阿里等众多厂商的移动产品，利用该漏洞的攻击者可以直接在用户手机中植入木马，盗取用户的短信照片等个人隐私，盗取银行、支付宝等账号密码等。</p>
</blockquote>
<p>提取下关键信息，漏洞影响千万APP，包括百度、腾讯、阿里的产品，通用安全漏洞，远程代码执行漏洞。<br>果真如此的话，这个漏洞简直犀利。</p>
<h2 id="细节"><a href="#细节" class="headerlink" title="细节"></a>细节</h2><p>今天早上看到了部分细节：<br><a href="http://www.aqniu.com/threat-alert/8371.html" target="_blank" rel="external">http://www.aqniu.com/threat-alert/8371.html</a><br>以及下午360自己在乌云公布的详细分析：<br><a href="http://drops.wooyun.org/papers/6910" target="_blank" rel="external">http://drops.wooyun.org/papers/6910</a><br>简单描述一下漏洞细节，APP在调用DexClassLoader函数动态加载插件时，如果函数第二个参数指定的odex文件存在，则会再一个简单的弱校验通过后直接加载该odex。<br>然而该漏洞是否向360描述的那般强大呢？接下来我将通过360提出的4种攻击场景介绍漏洞的局限：<br><strong>1）三星输入法远程命令执行漏洞</strong><br>CVE-2014-2865漏洞描述：</p>
<blockquote>
<p>在能够劫持你的网络前提下,攻击者能够利用三星自带输入法更新机制进行远程代码执行并且具有 system 权限。Swift输入法预装在三星手机中并且不能卸载和禁用.即使修改了默认输入法,这个漏洞也是可以利用的。</p>
</blockquote>
<p>由于Swift输入法具有system权限，可以直接替换/data/dalvik-cache目录下任意app的缓存文件。然而这个漏洞利用有着较大的局限性：</p>
<ol>
<li>设备为S4 Mini, S4, S5, S6在内的Samsung Galaxy S手机CVE</li>
<li>手机接入了一个不安全的网络环境中，使得攻击者进行中间人劫持</li>
</ol>
<p><strong>2）利用zip解压缩漏洞覆盖缓存代码</strong><br>app对zip文件进行解压遍历文件时，会调用ZipEntry.getName()方法，这个方法在官方文档描述了一个安全警告：<br>链接：<a href="http://developer.android.com/reference/java/util/zip/ZipEntry.html#getName(" target="_blank" rel="external">http://developer.android.com/reference/java/util/zip/ZipEntry.html#getName(</a>) Gets the name of this ZipEntry</p>
<blockquote>
<p>Security note: Entry names can represent relative paths. foo/../bar or ../bar/baz ,<br>for example. If the entry name is being used to construct a filename or as a path<br>component, it must be validated or sanitized to ensure that files are not written outside<br>of the intended destination directory.</p>
</blockquote>
<p>那么实际上，这是由于app开发者无视了这个安全警告，在调用ZipEntry.getName()方法后，没有对”../“跳转符做过滤，导致了目录遍历，使得app在解压恶意zip压缩包时以本app的权限覆盖了缓存文件。<br>局限性：</p>
<ol>
<li>app需要有解压zip压缩包的功能</li>
<li>不专业的app开发者</li>
<li>需要向被攻击者发送一个zip压缩包，并诱使被攻击者用该app解压或者手机接入了一个不安全的网络环境中，使得攻击者进行中间人劫持</li>
</ol>
<p><strong>3）利用adb backup覆盖缓存代码</strong><br>通过adb连接手机，使用adb backup备份app私有数据，对odex进行篡改后，使用adb restore恢复数据完成odex的替换。<br>局限性：</p>
<ol>
<li>manifest文件里没有指定allowBackup=”false” </li>
</ol>
<p><strong>4）其他可能的APP数据读写</strong><br>以root权限直接替换任意app的缓存文件。<br>局限性：</p>
<ol>
<li>当攻击者拥有了root权限，还需要替换odex这种繁琐的植入方式？？？</li>
</ol>
<h2 id="真相"><a href="#真相" class="headerlink" title="真相"></a>真相</h2><p>实际上大部分app都会将插件的缓存文件存放在私有目录下，由于Android的沙箱机制，攻击者要利用这个漏洞首先需要突破沙箱保护。可以看到，360提出的4种攻击场景全部利用了其他的漏洞或者app开发者的粗心大意，从而突破了沙箱保护。<br>另一方面，由于odex文件与VM版本相关，同一个odex无法在多个设备中正常运行，攻击者需要对识别不同的设备并适配不同的恶意odex，漏洞利用成本进一步加大。<br>总结一下漏洞利用成功的先决条件：</p>
<ol>
<li>Android版本低于5.0</li>
<li>利用了其他可突破沙箱保护的漏洞</li>
<li>适配设备的odex文件实例</li>
</ol>
<p>通过上面的分析，“寄生兽”漏洞虽然具有一定的影响面，然而这个漏洞的利用需要另外一个漏洞的帮助（用来突破沙箱保护），远远没有达到360对其描述的危害性。<br>引用网上(知乎id:shotgun)对这个漏洞的评价：</p>
<blockquote>
<p>这个漏洞的利用需要另外一个漏洞的帮助，不知道为什么我就想起了“太阳能电筒”。<br><img src="/images/Exaggerated-Android-Vulnerability-Parasyte_1.jpg" alt="1"><br>简单来说，这个漏洞必须要有能访问到私有目录的权限才能运行，所以需要一个能提供类似权限的其他漏洞，比如之前的三星虚拟键盘漏洞。</p>
<p>“这是无需电池的太阳能电筒。”<br>“那没有光呢？”<br>“它绝对不会亮！”<br>“有没有可能没有光也亮呢？”<br>“你可以用另外一只电筒照着它！”<br>“哦……”</p>
</blockquote>
<h2 id="防范与修复"><a href="#防范与修复" class="headerlink" title="防范与修复"></a>防范与修复</h2><p>如何防范？<br>从用户角度来看：</p>
<ol>
<li>升级Android版本到5.0以上</li>
<li>不要打开并解压来源不可信的zip压缩包</li>
<li>手机不要接入不安全的wifi无线热点</li>
<li>不要轻易root手机、已root手机管理好app的授权</li>
<li>不要通过adb连接到不可信的设备</li>
</ol>
<p>如何修复？</p>
<ol>
<li>每次调用DexClassLoader方法之前，清楚已经存在的odex</li>
<li>DexClassLoader方法的第二个参数（即odex的存放路径）不要指定在sdcard上</li>
<li>在调用zipEntry.getName()的时候，过滤返回值中的”../“跳转符</li>
<li>没有必要的情况下，请在manifest文件里显示指定allowBackup=”false” </li>
</ol>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>这里提供一个修改odex文件crc和modWhen的代码：<br><a href="https://github.com/ele7enxxh/FakeOdex" target="_blank" rel="external">https://github.com/ele7enxxh/FakeOdex</a><br>可用来生成一个恶意的odex，绕过弱检测。<br>PS：本人水平有限，上面的理解如果有错误，还请海涵。</p>

      
    </div>

    
      
      

  <div class="post-copyright">
    <p class="copyright-item">
      <span>作者: </span>
      <span>ele7enxxh</span>
    </p>
    <p class="copyright-item">
      <span>来源: </span>
      <a href="http://ele7enxxh.com">http://ele7enxxh.com</a>
    </p>
    <p class="copyright-item">
      <span>链接: </span>
      <a href="http://ele7enxxh.com/Exaggerated-Android-Vulnerability-Parasyte.html">http://ele7enxxh.com/Exaggerated-Android-Vulnerability-Parasyte.html</a>
    </p>

    <p class="copyright-item lincese">
      
      本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可
    </p>
  </div>



      
      
    

    
  </article>


          </div>
          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>

        </div>  
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:ele7enxxh@qq.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/ele7enxxh" class="iconfont icon-github" title="github"></a>
        
      
    
      
        
          <a href="http://weibo.com/ele7enxxh" class="iconfont icon-weibo" title="weibo"></a>
        
      
    
      
    
      
    
    
    
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>


<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a>
  </span>
  
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2015 - 
    
    2017

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">ele7enxxh</span>
  </span>
</div>
      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  
  
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://ele7enxxh.com/Exaggerated-Android-Vulnerability-Parasyte.html';
        this.page.identifier = 'Exaggerated-Android-Vulnerability-Parasyte.html';
        this.page.title = '被夸大的安卓漏洞“寄生兽”';
    };
    (function() {
    var d = document, s = d.createElement('script');

    s.src = '//ele7enxxh.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();  
  </script>




    
  





  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.2.x"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.2.x"></script>

    
  <script type="text/html" id="search-result">
    <article class="post">
      <header class="post-header">
        <h1 class="post-title">
          <a href="$url$" class="post-link">
            $title$
          </a>
        </h1>
      </header>
      <div class="post-content">
        $content$
        <div class="read-more">
          <a href="$url$" class="read-more-link">
            Read more..
          </a>
        </div>
      </div>
    </article>
  </script>
  <script type="text/html" id="no-search-result">
    <div class="no-result">
      <h2>No result found!</h2>
    </div>
  </script>
  <script type="text/javascript" src="/js/src/search.js?v=2.2.x"></script>

  </body>
</html>