<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Android安全"><title>0ctf 2016 State of the ART writeup | Ele7enxxh's Blog</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">0ctf 2016 State of the ART writeup</h1><a id="logo" href="/.">Ele7enxxh's Blog</a><p class="description">For you, a thousand times over</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">0ctf 2016 State of the ART writeup</h1><div class="post-meta">Mar 23, 2016<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="0ctf-2016-State-Of-The-ART-Writeup.html" href="/0ctf-2016-State-Of-The-ART-Writeup.html#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>本文为2016年0ctf中的mobile题目State of the ART的writeup。<a id="more"></a></p>
<p><img src="/images/0ctf-2016-State-of-the-ART-writeup-1.png" alt="1"></p>
<h2 id="State-of-the-ART-writeup"><a href="#State-of-the-ART-writeup" class="headerlink" title="State of the ART writeup"></a>State of the ART writeup</h2><p>首先<a href="/downloads/0ctf-2016-State-of-the-ART.zip">点我</a>下载题目，这道题提供了三个文件，分别为：</p>
<blockquote>
<p>a：内存布局文件<br>b：oatdump的结果文件<br>c：boot.oat文件</p>
</blockquote>
<p>经过对几个文件的初步观察，发现在b文件中找到一个可疑函数<code>oat.sjl.gossip.oat.MainActivity.check(java.lang.String)</code>，函数名字可不会乱取，此函数肯定和Flag密切相关，因此需要还原出该方法。可惜，出题者有意抹去了oatdump中的dalvik字节码，不然这道题会简单的多。<br>我们分段分析汇编代码，首先看下面一段：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">0x00371e8c: b099        sub     sp, sp, #100</div><div class="line">0x00371e8e: 9000        str     r0, [sp, #0]</div><div class="line">0x00371e90: 9121        str     r1, [sp, #132]</div><div class="line">0x00371e92: 9222        str     r2, [sp, #136]</div><div class="line">0x00371e94: f8d9e11c    ldr.w   lr, [r9, #284]  ; pAllocArrayResolved</div><div class="line">0x00371e98: 9900        ldr     r1, [sp, #0]</div><div class="line">0x00371e9a: 2606        movs    r6, #6</div><div class="line">0x00371e9c: 1c32        mov     r2, r6</div><div class="line">0x00371e9e: f64e0020    movw    r0, #59424</div><div class="line">0x00371ea2: f2c7005b    movt    r0, #28763</div><div class="line">0x00371ea6: 47f0        blx     lr</div></pre></td></tr></table></figure></p>
<p>其中pAllocArrayResolved对应的是artAllocArrayFromCode函数，原型为：<br><code>extern &quot;C&quot; mirror::Array* artAllocArrayFromCode##suffix##suffix2(uint32_t type_idx, mirror::ArtMethod* method, int32_t component_count, Thread* self, StackReference&lt;mirror::ArtMethod&gt;* sp)</code><br>根据分析，其功能是创建数组，其包含3个参数，r0为创建对象的类型，r1为method对象，r2为待创建数组元素的个数，返回值存放在r0，返回类型为mirror::Array*。<br>下一段代码为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">0x00371ea8: f8d9e190    ldr.w   lr, [r9, #400]  ; pHandleFillArrayData</div><div class="line">0x00371eac: 4682        mov     r10, r0</div><div class="line">0x00371eae: 4650        mov     r0, r10</div><div class="line">0x00371eb0: f20f6144    adr     r1, +1604 (0x003724f8)</div><div class="line">0x00371eb4: 47f0        blx     lr</div></pre></td></tr></table></figure></p>
<p>其中pHandleFillArrayData对应的是artHandleFillArrayDataFromCode函数，原型为：<br><code>extern &quot;C&quot; int artHandleFillArrayDataFromCode(mirror::Array* array, const Instruction::ArrayDataPayload* payload, Thread* self, StackReference&lt;mirror::ArtMethod&gt;* sp)</code><br>根据分析，其功能是初始化数组，其包含2个参数，r0为待初始化的数组对象，也就是pAllocArrayResolved的返回值，r1指向赋值内容，其类型为Instruction::ArrayDataPayload*，对应的数据结构为：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">struct</span> <span class="title">PACKED</span><span class="params">(<span class="number">4</span>)</span> ArrayDataPayload </span>&#123;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">uint16_t</span> ident;           <span class="comment">// 标志</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">uint16_t</span> element_width;   <span class="comment">// 每一个元素的大小</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">uint32_t</span> element_count;   <span class="comment">// 元素的个数</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span> data[];           <span class="comment">//指向真正的数据</span></div><div class="line">    ...</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>r1的值为0x003724f8，其对应的区域为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">0x003724f8: 0300        lsls    r0, r0, #12</div><div class="line">0x003724fa: 0001        lsls    r1, r0, #0</div><div class="line">0x003724fc: 0006        lsls    r6, r0, #0</div><div class="line">0x003724fe: 0000        lsls    r0, r0, #0</div><div class="line">0x00372500: 4578        cmp     r0, pc</div><div class="line">0x00372502: 3278        adds    r2, #120</div><div class="line">0x00372504: 3757        adds    r7, #87</div><div class="line">0x00372506: 0000        lsls    r0, r0, #0</div></pre></td></tr></table></figure></p>
<p>ident为固定值，也就是0x0300，element_width为1,表示每一个元素的大小为1，也就是说这是一个byte数组，element_count为6，表示数组包含6个byte元素。同理后续几段汇编依次创建并初始化了5个byte数组。<br>上述汇编共创建并初始化了6个byte数组，对应的Java源码为：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 每行的注释指的的是该数组对象的存放位置</span></div><div class="line"><span class="keyword">byte</span>[] s1 = <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;<span class="number">0x78</span>, <span class="number">0x45</span>, <span class="number">0x78</span>, <span class="number">0x32</span>, <span class="number">0x57</span>, <span class="number">0x37</span>&#125;;           <span class="comment">// r10</span></div><div class="line"><span class="keyword">byte</span>[] s2 = <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;<span class="number">0x22</span>, <span class="number">0x29</span>, <span class="number">0x44</span>, <span class="number">0x55</span>, <span class="number">0x60</span>, <span class="number">0x33</span>&#125;;           <span class="comment">// r7</span></div><div class="line"><span class="keyword">byte</span>[] s3 = <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;<span class="number">0x17</span>, <span class="number">0x94</span>, <span class="number">0x35</span>, <span class="number">0x03</span>, <span class="number">0x90</span>&#125;;                 <span class="comment">// [sp, #56]</span></div><div class="line"><span class="keyword">byte</span>[] s4 = <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;<span class="number">0x45</span>, <span class="number">0x64</span>, <span class="number">0x5f</span>, <span class="number">0x41</span>,<span class="number">0x52</span>, <span class="number">0x54</span>, <span class="number">0x7d</span>&#125;;    <span class="comment">// [sp, #60]</span></div><div class="line"><span class="keyword">byte</span>[] s5 = <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;<span class="number">0x58</span>, <span class="number">0x75</span>, <span class="number">0x1b</span>, <span class="number">0xf0</span>, <span class="number">0x0f</span>, <span class="number">0x4c</span>&#125;;         <span class="comment">// r11</span></div><div class="line"><span class="keyword">byte</span>[] s6 = <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;<span class="number">0x69</span>, <span class="number">0x0c</span>, <span class="number">0x1b</span>, <span class="number">0xbe</span>, <span class="number">0xf2</span>, <span class="number">0x49</span>&#125;;         <span class="comment">//[sp, #52]</span></div></pre></td></tr></table></figure></p>
<p>再看下面一段：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">0x00371f60: 2500        movs    r5, #0</div><div class="line">0x00371f62: 68be        ldr     r6, [r7, #8]        // r7指向s2数组的mirror::Array对象，r6为s2数组包含的元素个数</div><div class="line">0x00371f64: 42b5        cmp     r5, r6</div><div class="line">0x00371f66: f2808034    bge.w   +104 (0x00371fd2)   // 这里就是一个for循环</div><div class="line">0x00371f6a: 68ba        ldr     r2, [r7, #8]</div><div class="line">0x00371f6c: f117030c    adds    r3, r7, #12</div><div class="line">0x00371f70: 4295        cmp     r5, r2</div><div class="line">0x00371f72: f0808248    bcs.w   +1168 (0x00372406)  // 对s2数组进行边界判断</div><div class="line">0x00371f76: 575e        ldrsb   r6, [r3, r5]        // r6 = s2[r5]，也就是取出s2数组的元素</div><div class="line">0x00371f78: 68b8        ldr     r0, [r7, #8]</div><div class="line">0x00371f7a: f1160636    adds    r6, r6, #54         // r6 = s2[r5] + 54</div><div class="line">0x00371f7e: f3460607    UNKNOWN 52                  // SBFX.W    R6, R6, #0, #8</div><div class="line">0x00371f82: f1170c0c    adds    r12, r7, #12</div><div class="line">0x00371f86: 4285        cmp     r5, r0</div><div class="line">0x00371f88: f0808242    bcs.w   +1156 (0x00372410)  // 对s2数组进行边界判断</div><div class="line">0x00371f8c: f80c6005    strb    r6, [r12, r5]</div><div class="line">0x00371f90: 68b9        ldr     r1, [r7, #8]</div><div class="line">0x00371f92: f117020c    adds    r2, r7, #12</div><div class="line">0x00371f96: 428d        cmp     r5, r1</div><div class="line">0x00371f98: f080823f    bcs.w   +1150 (0x0037241a)  // 对s2数组进行边界判断</div><div class="line">0x00371f9c: 5756        ldrsb   r6, [r2, r5]</div><div class="line">0x00371f9e: 9b0d        ldr     r3, [sp, #52]       // 取出s6数组的mirror::Array对象的首地址</div><div class="line">0x00371fa0: f8d3c008    ldr.w   r12, [r3, #8]</div><div class="line">0x00371fa4: f113000c    adds    r0, r3, #12         // 取出s6数组的mirror::Array对象中数据区域的首地址</div><div class="line">0x00371fa8: 4565        cmp     r5, r12</div><div class="line">0x00371faa: f080823a    bcs.w   +1140 (0x00372422)  // 对s6数组进行边界判断</div><div class="line">0x00371fae: f9108005    UNKNOWN 17                  // ldrsb.w    r8, [r0, r5]，也就是r8 = s6[r5]</div><div class="line">0x00371fb2: 68ba        ldr     r2, [r7, #8]</div><div class="line">0x00371fb4: ea860608    eor.w   r6, r6, r8          // r6 = (s2[r5] + 54) ^ s6[r5]</div><div class="line">0x00371fb8: f3460607    UNKNOWN 52                  // SBFX.W    R6, R6, #0, #8</div><div class="line">0x00371fbc: f117010c    adds    r1, r7, #12</div><div class="line">0x00371fc0: 4295        cmp     r5, r2</div><div class="line">0x00371fc2: f0808233    bcs.w   +1126 (0x0037242c)  // 对s2数组进行边界判断</div><div class="line">0x00371fc6: 554e        strb    r6, [r1, r5]        // s2[r5] = (s2[r5] + 54) ^ s6[r5]</div><div class="line">0x00371fc8: 1c6d        adds    r5, r5, #1          // r5 += 1</div><div class="line">0x00371fca: 3c01        subs    r4, #1</div><div class="line">0x00371fcc: f47fafc9    bne.w   -110 (0x00371f62)   // 循环，这里跳回去</div></pre></td></tr></table></figure></p>
<p>可以看到，上面汇编代码里含有大量的边界判断的跳转，这些应该是系统自动添加的一些处理，我们可以忽略掉。另外需要我们对mirror::Array类型有一定的了解。汇编代码中出现的UNKNOWN部分，应该是oatdump没有识别出这些指令，我们可以利用ida识别出来。这段对应的Java源码为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">for (int i = 0; i &lt; s2.length; ++i) &#123;</div><div class="line">    s2[i] = (byte) ((s2[i] + 54) ^ s6[i]);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续下一段：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">0x00371fd2: 2500        movs    r5, #0</div><div class="line">0x00371fd4: f8da6008    ldr.w   r6, [r10, #8]</div><div class="line">0x00371fd8: 42b5        cmp     r5, r6</div><div class="line">0x00371fda: f2808051    bge.w   +162 (0x00372080)   // 这里就是一个for循环</div><div class="line">0x00371fde: f8da3008    ldr.w   r3, [r10, #8]</div><div class="line">0x00371fe2: f11a0c0c    adds    r12, r10, #12</div><div class="line">0x00371fe6: 429d        cmp     r5, r3</div><div class="line">0x00371fe8: f0808229    bcs.w   +1106 (0x0037243e)  // 对s1数组进行边界判断</div><div class="line">0x00371fec: f91c6005    UNKNOWN 17                  // ldrsb.w r6, [r12, r5]，也就是r6 = s1[r5]</div><div class="line">0x00371ff0: f04f0857    mov.w   r8, #87</div><div class="line">0x00371ff4: 4546        cmp     r6, r8              // s1[r5]和87比较</div><div class="line">0x00371ff6: f0408009    bne.w   +18 (0x0037200c)    // 如果不等则跳向0x0037200c，等于则跳向0x00371ffa</div><div class="line">0x00371ffa: f8da1008    ldr.w   r1, [r10, #8]</div><div class="line">0x00371ffe: 2669        movs    r6, #105            // r6 = 105</div><div class="line">0x00372000: f11a000c    adds    r0, r10, #12</div><div class="line">0x00372004: 428d        cmp     r5, r1</div><div class="line">0x00372006: f080821f    bcs.w   +1086 (0x00372448)  // 对s1数组进行边界判断</div><div class="line">0x0037200a: 5546        strb    r6, [r0, r5]        // s1[r5] = 105</div><div class="line">0x0037200c: f8da2008    ldr.w   r2, [r10, #8]</div><div class="line">0x00372010: f11a030c    adds    r3, r10, #12</div><div class="line">0x00372014: 4295        cmp     r5, r2</div><div class="line">0x00372016: f080821b    bcs.w   +1078 (0x00372450)  // 对s1数组进行边界判断</div><div class="line">0x0037201a: 575e        ldrsb   r6, [r3, r5]        // r6 = s1[r5]</div><div class="line">0x0037201c: f04f0832    mov.w   r8, #50</div><div class="line">0x00372020: 4546        cmp     r6, r8              // s1[r5]和50比较</div><div class="line">0x00372022: f040800b    bne.w   +22 (0x0037203c)    // 如果不等则跳向0x0037203c，等于则跳向0x00372026</div><div class="line">0x00372026: f8da0008    ldr.w   r0, [r10, #8]</div><div class="line">0x0037202a: f06f067b    mvn     r6, #123            // r6 = ~123</div><div class="line">0x0037202e: f11a0c0c    adds    r12, r10, #12</div><div class="line">0x00372032: 4285        cmp     r5, r0</div><div class="line">0x00372034: f0808211    bcs.w   +1058 (0x0037245a)  // 对s1数组进行边界判断</div><div class="line">0x00372038: f80c6005    strb    r6, [r12, r5]       // s1[r5] = ~123</div><div class="line">0x0037203c: f8da1008    ldr.w   r1, [r10, #8]</div><div class="line">0x00372040: f11a020c    adds    r2, r10, #12</div><div class="line">0x00372044: 428d        cmp     r5, r1</div><div class="line">0x00372046: f080820d    bcs.w   +1050 (0x00372464)  // 对s1数组进行边界判断</div><div class="line">0x0037204a: 5756        ldrsb   r6, [r2, r5]</div><div class="line">0x0037204c: f8db3008    ldr.w   r3, [r11, #8]</div><div class="line">0x00372050: f11b0c0c    adds    r12, r11, #12</div><div class="line">0x00372054: 429d        cmp     r5, r3</div><div class="line">0x00372056: f0808209    bcs.w   +1042 (0x0037246c)  // 对s5数组进行边界判断</div><div class="line">0x0037205a: f91c8005    UNKNOWN 17                  // ldrsb.w r8, [r12, r5]，也就是r8 = s5[r5]</div><div class="line">0x0037205e: f8da1008    ldr.w   r1, [r10, #8]</div><div class="line">0x00372062: ea860608    eor.w   r6, r6, r8          // r6 = s1[r5] ^ s5[r5]</div><div class="line">0x00372066: f3460607    UNKNOWN 52                  // SBFX.W    R6, R6, #0, #8</div><div class="line">0x0037206a: f11a000c    adds    r0, r10, #12</div><div class="line">0x0037206e: 428d        cmp     r5, r1</div><div class="line">0x00372070: f0808201    bcs.w   +1026 (0x00372476)  // 对s1数组进行边界判断</div><div class="line">0x00372074: 5546        strb    r6, [r0, r5]        // s1[r5] = s1[r5] ^ s5[r5]</div><div class="line">0x00372076: 1c6d        adds    r5, r5, #1</div><div class="line">0x00372078: 3c01        subs    r4, #1</div><div class="line">0x0037207a: f47fafab    bne.w   -170 (0x00371fd4)   // 循环，这里跳回去</div></pre></td></tr></table></figure></p>
<p>这段对应的Java源码为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">for (int i = 0; i &lt; s1.length; i++) &#123;</div><div class="line">    if (s1[i] == 87) &#123;</div><div class="line">        s1[i] = 105;</div><div class="line">    &#125;</div><div class="line">    if (s1[i] == 50) &#123;</div><div class="line">        s1[i] = ~(123);</div><div class="line">    &#125;</div><div class="line">    s1[i] = (byte) (s1[i] ^ s5[i]);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续下一段：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">0x00372080: f8da6008    ldr.w   r6, [r10, #8]   // r6 = s1.length</div><div class="line">0x00372084: f8d9e11c    ldr.w   lr, [r9, #284]  ; pAllocArrayResolved</div><div class="line">0x00372088: f8d78008    ldr.w   r8, [r7, #8]    // r8 = s2.length</div><div class="line">0x0037208c: 9900        ldr     r1, [sp, #0]</div><div class="line">0x0037208e: eb160608    adds.w  r6, r6, r8      // r6 = s1.length + s2.length</div><div class="line">0x00372092: 1c32        mov     r2, r6</div><div class="line">0x00372094: f64e0020    movw    r0, #59424</div><div class="line">0x00372098: f2c7005b    movt    r0, #28763</div><div class="line">0x0037209c: 47f0        blx     lr</div></pre></td></tr></table></figure></p>
<p>对应的Java源码为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">byte[] d1 = new byte[s1.length + s2.length];    // [sp, #40]</div></pre></td></tr></table></figure></p>
<p>继续下一段：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">0x0037209e: f8da2008    ldr.w   r2, [r10, #8]</div><div class="line">0x003720a2: 900a        str     r0, [sp, #40]</div><div class="line">0x003720a4: 2600        movs    r6, #0</div><div class="line">0x003720a6: 9800        ldr     r0, [sp, #0]</div><div class="line">0x003720a8: f04f0800    mov.w   r8, #0</div><div class="line">0x003720ac: 9216        str     r2, [sp, #88]</div><div class="line">0x003720ae: 9a16        ldr     r2, [sp, #88]</div><div class="line">0x003720b0: f8cd8010    str.w   r8, [sp, #16]</div><div class="line">0x003720b4: 68c0        ldr     r0, [r0, #12]</div><div class="line">0x003720b6: f24f0cd8    movw    r12, #61656</div><div class="line">0x003720ba: f850000c    ldr.w   r0, [r0, r12]</div><div class="line">0x003720be: 9205        str     r2, [sp, #20]</div><div class="line">0x003720c0: f8d0e028    ldr.w   lr, [r0, #40]</div><div class="line">0x003720c4: 9b0a        ldr     r3, [sp, #40]   // r3为d1数组对象</div><div class="line">0x003720c6: 4651        mov     r1, r10         // r1为s1数组对象</div><div class="line">0x003720c8: 1c32        mov     r2, r6          // r2 = 0</div><div class="line">0x003720ca: 47f0        blx     lr              // 这是执行什么函数？</div></pre></td></tr></table></figure></p>
<p>这里最后的跳转，lr的值是无法计算出来的。最开始我尝试对获取lr的过程进行分析，但是这里取值的过程绕了多次，因此放弃了这种方法。我们在整个文件中搜索<code>#61656</code>，找到下面一段代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">3: java.lang.Object[] android.support.v4.content.FileProvider.copyOf(java.lang.Object[], int) (dex_method_idx=2961)</div><div class="line">  DEX CODE:</div><div class="line">    0x0000: const/4 v1, #+0</div><div class="line">    0x0001: new-array v0, v3, java.lang.Object[] // type@2035</div><div class="line">    0x0003: invoke-static &#123;v2, v1, v0, v1, v3&#125;, void java.lang.System.arraycopy(java.lang.Object, int, java.lang.Object, int, int) // method@15411</div><div class="line">    ...</div><div class="line">    0x00216b14: 1c05        mov     r5, r0</div><div class="line">    0x00216b16: 1c38        mov     r0, r7</div><div class="line">    0x00216b18: 68c0        ldr     r0, [r0, #12]</div><div class="line">    0x00216b1a: 2200        movs    r2, #0</div><div class="line">    0x00216b1c: 9204        str     r2, [sp, #16]</div><div class="line">    0x00216b1e: f24f0cd8    movw    r12, #61656</div><div class="line">    0x00216b22: f850000c    ldr.w   r0, [r0, r12]</div><div class="line">    0x00216b26: 9605        str     r6, [sp, #20]</div><div class="line">    0x00216b28: f8d0e028    ldr.w   lr, [r0, #40]</div><div class="line">    0x00216b2c: 4641        mov     r1, r8</div><div class="line">    0x00216b2e: 2200        movs    r2, #0</div><div class="line">    0x00216b30: 1c2b        mov     r3, r5</div><div class="line">    0x00216b32: 47f0        blx     lr</div></pre></td></tr></table></figure></p>
<p>和上面的代码对比，不难发现执行的即为<code>java.lang.System.arraycopy</code>函数，因此前面汇编代码对应的Java源码为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">System.arraycopy(s1, 0, d1, 0, s1.length);</div></pre></td></tr></table></figure></p>
<p>继续下一段：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">0x003720cc: f8da8008    ldr.w   r8, [r10, #8]</div><div class="line">0x003720d0: 68b8        ldr     r0, [r7, #8]</div><div class="line">0x003720d2: 2600        movs    r6, #0</div><div class="line">0x003720d4: 9016        str     r0, [sp, #88]</div><div class="line">0x003720d6: 9800        ldr     r0, [sp, #0]</div><div class="line">0x003720d8: 9a16        ldr     r2, [sp, #88]</div><div class="line">0x003720da: f8cd8010    str.w   r8, [sp, #16]</div><div class="line">0x003720de: 68c0        ldr     r0, [r0, #12]</div><div class="line">0x003720e0: f24f0cd8    movw    r12, #61656</div><div class="line">0x003720e4: f850000c    ldr.w   r0, [r0, r12]</div><div class="line">0x003720e8: 9205        str     r2, [sp, #20]</div><div class="line">0x003720ea: f8d0e028    ldr.w   lr, [r0, #40]</div><div class="line">0x003720ee: 9b0a        ldr     r3, [sp, #40]   //  r3为o1数组对象</div><div class="line">0x003720f0: 1c39        mov     r1, r7          //  r1为b2数组对象  </div><div class="line">0x003720f2: 1c32        mov     r2, r6          //  r2为0</div><div class="line">0x003720f4: 47f0        blx     lr              // 跳转System.arraycopy函数</div></pre></td></tr></table></figure></p>
<p>对应的Java源码为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">System.arraycopy(s2, 0, d1, s2.length, s2.length);</div></pre></td></tr></table></figure></p>
<p>继续下一段：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">0x003720f6: 980e        ldr     r0, [sp, #56]       // r0为s3数组对象</div><div class="line">0x003720f8: 2604        movs    r6, #4</div><div class="line">0x003720fa: f04f0804    mov.w   r8, #4</div><div class="line">0x003720fe: 6881        ldr     r1, [r0, #8]</div><div class="line">0x00372100: 2904        cmp     r1, #4</div><div class="line">0x00372102: f24081c0    bls.w   +896 (0x00372486)   // 对s3数组进行边界判断</div><div class="line">0x00372106: f9908010    ldrsb.w r8, [r0, #16]       // r8 = s3[4]</div><div class="line">0x0037210a: 6882        ldr     r2, [r0, #8]</div><div class="line">0x0037210c: f1b80831    subs    r8, r8, #49         // r8 = s3[4] - 49</div><div class="line">0x00372110: f3480807    UNKNOWN 52                  // SBFX.W    R8, R8, #0, #8</div><div class="line">0x00372114: 2a04        cmp     r2, #4</div><div class="line">0x00372116: f24081ba    bls.w   +884 (0x0037248e)   // 对s3数组进行边界判断</div><div class="line">0x0037211a: f8808010    strb    r8, [r0,#16]        // s3[4] = s3[4] - 49</div><div class="line">0x0037211e: 6883        ldr     r3, [r0, #8]</div><div class="line">0x00372120: 2603        movs    r6, #3</div><div class="line">0x00372122: f04f0803    mov.w   r8, #3</div><div class="line">0x00372126: 2b03        cmp     r3, #3</div><div class="line">0x00372128: f24081b6    bls.w   +876 (0x00372498)   // 对s3数组进行边界判断</div><div class="line">0x0037212c: f990800f    ldrsb.w r8, [r0, #15]       // r8 = s3[3]</div><div class="line">0x00372130: f8d0c008    ldr.w   r12, [r0, #8]</div><div class="line">0x00372134: f118082f    adds    r8, r8, #47         // r8 = s3[3] + 47</div><div class="line">0x00372138: f3480807    UNKNOWN 52                  // SBFX.W    R8, R8, #0, #8</div><div class="line">0x0037213c: f1bc0f03    cmp.w   r12, #3</div><div class="line">0x00372140: f24081af    bls.w   +862 (0x003724a2)   // 对s3数组进行边界判断</div><div class="line">0x00372144: f880800f    strb    r8, [r0,#15]        // s3[3] = s3[3] + 47</div><div class="line">0x00372148: 6881        ldr     r1, [r0, #8]</div><div class="line">0x0037214a: 2602        movs    r6, #2</div><div class="line">0x0037214c: f04f0802    mov.w   r8, #2</div><div class="line">0x00372150: 2902        cmp     r1, #2</div><div class="line">0x00372152: f24081ab    bls.w   +854 (0x003724ac)   // 对s3数组进行边界判断</div><div class="line">0x00372156: f990800e    ldrsb.w r8, [r0, #14]       // r8 = s3[2]</div><div class="line">0x0037215a: 6882        ldr     r2, [r0, #8]</div><div class="line">0x0037215c: f118082a    adds    r8, r8, #42         // r8 = s3[2] + 42</div><div class="line">0x00372160: f3480807    UNKNOWN 52                  // SBFX.W    R8, R8, #0, #8</div><div class="line">0x00372164: 2a02        cmp     r2, #2</div><div class="line">0x00372166: f24081a5    bls.w   +842 (0x003724b4)   // 对s3数组进行边界判断</div><div class="line">0x0037216a: f880800e    strb    r8, [r0,#14]        // s3[2] = s3[2] + 42</div><div class="line">0x0037216e: 6883        ldr     r3, [r0, #8]</div><div class="line">0x00372170: 2601        movs    r6, #1</div><div class="line">0x00372172: f04f0801    mov.w   r8, #1</div><div class="line">0x00372176: 2b01        cmp     r3, #1</div><div class="line">0x00372178: f24081a1    bls.w   +834 (0x003724be)   // 对s3数组进行边界判断</div><div class="line">0x0037217c: f990800d    ldrsb.w r8, [r0, #13]       // r8 = s3[1]</div><div class="line">0x00372180: f8d0c008    ldr.w   r12, [r0, #8]</div><div class="line">0x00372184: f1b80822    subs    r8, r8, #34         // r8 = s3[1] - 34</div><div class="line">0x00372188: f3480807    UNKNOWN 52                  // SBFX.W    R8, R8, #0, #8</div><div class="line">0x0037218c: f1bc0f01    cmp.w   r12, #1</div><div class="line">0x00372190: f240819a    bls.w   +820 (0x003724c8)   // 对s3数组进行边界判断</div><div class="line">0x00372194: f880800d    strb    r8, [r0,#13]        // s3[1] = s3[1] - 34</div><div class="line">0x00372198: 6881        ldr     r1, [r0, #8]</div><div class="line">0x0037219a: 2600        movs    r6, #0</div><div class="line">0x0037219c: f04f0800    mov.w   r8, #0</div><div class="line">0x003721a0: 2900        cmp     r1, #0</div><div class="line">0x003721a2: f0008196    beq.w   +812 (0x003724d2)   // 对s3数组进行边界判断</div><div class="line">0x003721a6: f990800c    ldrsb.w r8, [r0, #12]       // r8 = s3[0]</div><div class="line">0x003721aa: 6882        ldr     r2, [r0, #8]</div><div class="line">0x003721ac: f118082e    adds    r8, r8, #46         // r8 = s3[0] + 46</div><div class="line">0x003721b0: f3480807    UNKNOWN 52                  // SBFX.W    R8, R8, #0, #8</div><div class="line">0x003721b4: 2a00        cmp     r2, #0</div><div class="line">0x003721b6: f0008190    beq.w   +800 (0x003724da)   // 对s3数组进行边界判断</div><div class="line">0x003721ba: 9900        ldr     r1, [sp, #0]</div><div class="line">0x003721bc: f880800c    strb    r8, [r0,#12]        // s3[0] = s3[0] + 46</div></pre></td></tr></table></figure></p>
<p>对应的Java源码为：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">s3[<span class="number">4</span>] = (<span class="keyword">byte</span>) (s3[<span class="number">4</span>] - <span class="number">49</span>);</div><div class="line">s3[<span class="number">3</span>] = (<span class="keyword">byte</span>) (s3[<span class="number">3</span>] + <span class="number">47</span>);</div><div class="line">s3[<span class="number">2</span>] = (<span class="keyword">byte</span>) (s3[<span class="number">2</span>] + <span class="number">42</span>);</div><div class="line">s3[<span class="number">1</span>] = (<span class="keyword">byte</span>) (s3[<span class="number">1</span>] - <span class="number">34</span>);</div><div class="line">s3[<span class="number">0</span>] = (<span class="keyword">byte</span>) (s3[<span class="number">0</span>] + <span class="number">46</span>);</div></pre></td></tr></table></figure></p>
<p>继续下一段：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">0x003721c0: f8d9e12c    ldr.w   lr, [r9, #300]  ; pAllocObjectInitialized</div><div class="line">0x003721c4: f64b10e0    movw    r0, #47584</div><div class="line">0x003721c8: f2c70049    movt    r0, #28745</div><div class="line">0x003721cc: 47f0        blx     lr</div></pre></td></tr></table></figure></p>
<p>其中pAllocObjectInitialized是初始化一个对象，类型通过r0确定，我们在整个文件搜索<code>movw    r0, #47584</code>和<code>movt    r0, #28745</code>，从而确定了此处对应的dalvik字节码为<code>new-instance v0, java.lang.StringBuilder</code>。<br>继续下一段：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">0x003721ce: f8d9e12c    ldr.w   lr, [r9, #300]  ; pAllocObjectInitialized</div><div class="line">0x003721d2: 9900        ldr     r1, [sp, #0]</div><div class="line">0x003721d4: 9012        str     r0, [sp, #72]</div><div class="line">0x003721d6: f64b00f0    movw    r0, #47344</div><div class="line">0x003721da: f2c7003e    movt    r0, #28734</div><div class="line">0x003721de: 47f0        blx     lr</div></pre></td></tr></table></figure></p>
<p>同样的方法，此处对应的dalvik字节码为<code>new-instance v1, java.lang.String</code>。<br>继续下一段：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">0x003721e0: 9a0e        ldr     r2, [sp, #56]   // r2为s3数组对象</div><div class="line">0x003721e2: 1c06        mov     r6, r0          // r6为上面新建的String对象</div><div class="line">0x003721e4: f2461ef9    movw    lr, #25081  </div><div class="line">0x003721e8: f2c72ea0    movt    lr, #29344</div><div class="line">0x003721ec: f64300b0    movw    r0, #14512</div><div class="line">0x003721f0: f2c70044    movt    r0, #28740</div><div class="line">0x003721f4: 1c31        mov     r1, r6</div><div class="line">0x003721f6: 47f0        blx     lr</div></pre></td></tr></table></figure></p>
<p>这里遇到一个问题，在整个文件中并没有找到匹配的地方，无法得知这里跳转到哪里。我们来计算下lr的值，通过<code>movw    lr, #25081</code>和<code>movt    lr, #29344</code>计算得到lr的值为0x72a061F9，也就是说这里跳转到了0x72a061F9这个地址。那么0x72a061F9这里又是什么呢？注意题目一共给我们提供了三个文件，到目前为止我们只用了b文件，a文件提供了内存布局信息，看a文件中的下面一段信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">70eee000-7298b000 r--p 00000000 b3:17 185109     /data/dalvik-cache/arm/system@framework@boot.oat</div><div class="line">7298b000-73e43000 r-xp 01a9d000 b3:17 185109     /data/dalvik-cache/arm/system@framework@boot.oat</div><div class="line">73e43000-73e44000 rw-p 02f55000 b3:17 185109     /data/dalvik-cache/arm/system@framework@boot.oat</div></pre></td></tr></table></figure></p>
<p>上面是boot.oat的内存布局，地址0x72a061F9刚好位于boot.oat的代码段，而boot.oat就是题目提供给我们的c文件。我们来算一算0x72a061F9对应到c文件中的地址。首先我们设置这样几个变量：offset_in_file（文件中的偏移），offset_in_memory（在内存中的偏移），virtual_start_addr（虚拟内存区域的起始地址），physics_start_addr（文件中的起始地址）。offset_in_file的计算公式为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">offset_in_file = offset_in_memory - virtual_start_addr + physics_start_addr</div></pre></td></tr></table></figure></p>
<p>因此地址0x72a061F9对应的boot.oat文件中的地址为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">offset_in_file = 0x72a061F9 - 0x7298b000 + 0x01a9d000 - 1</div><div class="line">               = 0x1B181F8</div><div class="line">// 因为thumb的关系，所以需要-1</div></pre></td></tr></table></figure></p>
<p>ok，现在我们找到跳转的地址为boot.oat中的0x1B181F8，接下来我们需要得到boot.oat中的代码，使用oatdump即可。不幸的是我得到这样一个错误：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Failed to open oat file from &apos;/home/secauo/Android/0ctf_2016/state_of_the_art/state_of_the_art/c&apos;: Invalid oat magic for &apos;/home/secauo/Android/0ctf_2016/state_of_the_art/state_of_the_art/c&apos;</div></pre></td></tr></table></figure></p>
<p>好吧，oat magic错误，那么就是oat版本的原因了，从b文件得知，magic为039，因此对应的Android版本应该为5.0。再次使用Android5.0的oatdump，将结果保存为c.dump。由于未知的原因（或许是对齐？），地址差了0x1000，也就是为0x1B181F8 - 0x1000 = 0x1b171f8，查看c.dump，此处汇编为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">6: void java.lang.String.&lt;init&gt;(byte[]) (dex_method_idx=3180)</div><div class="line">  DEX CODE:</div><div class="line">    0x0000: const/4 v0, #+0</div><div class="line">    0x0001: array-length v1, v3</div><div class="line">    0x0002: invoke-direct &#123;v2, v3, v0, v1&#125;, void java.lang.String.&lt;init&gt;(byte[], int, int) // method@3182</div><div class="line">    0x0005: return-void</div><div class="line">  OatMethodOffsets (offset=0x0150b098)</div><div class="line">    code_offset: 0x01b171f9 </div><div class="line">    gc_map: (offset=0x015fbe3b)</div><div class="line">  OatQuickMethodHeader (offset=0x01b171e0)</div><div class="line">    mapping_table: (offset=0x018e15b7)</div><div class="line">    vmap_table: (offset=0x01a7c99a)</div><div class="line">    v3/r5, v1/r6, v2/r7, v65534/r8, v65535/r15</div><div class="line">  QuickMethodFrameInfo</div><div class="line">    frame_size_in_bytes: 64</div><div class="line">    core_spill_mask: 0x000081e0 (r5, r6, r7, r8, r15)</div><div class="line">    fp_spill_mask: 0x00000000 </div><div class="line">  CODE: (code_offset=0x01b171f9 size_offset=0x01b171f4 size=80)...</div><div class="line">    0x01b171f8: f5bd5c00    subs    r12, sp, #8192</div></pre></td></tr></table></figure></p>
<p>也就是说0x1b171f8（即内存地址0x72a061F9）指向<code>java.lang.String.&lt;init&gt;(byte[])</code>函数。回到b文件中check函数的分析，0x003721f6此处的’blx     lr’，也就是跳转到<code>java.lang.String.&lt;init&gt;(byte[])</code>函数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">0x003721e0: 9a0e        ldr     r2, [sp, #56]   // r2为s3数组对象</div><div class="line">0x003721e2: 1c06        mov     r6, r0          // r6为上面新建的String对象</div><div class="line">0x003721e4: f2461ef9    movw    lr, #25081  </div><div class="line">0x003721e8: f2c72ea0    movt    lr, #29344</div><div class="line">0x003721ec: f64300b0    movw    r0, #14512</div><div class="line">0x003721f0: f2c70044    movt    r0, #28740</div><div class="line">0x003721f4: 1c31        mov     r1, r6</div><div class="line">0x003721f6: 47f0        blx     lr             // 跳转到java.lang.String.&lt;init&gt;(byte[])</div></pre></td></tr></table></figure></p>
<p>对应的Java源码为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">String str1 = new String(s3);</div></pre></td></tr></table></figure></p>
<p>后面类似的跳转到c文件的函数，将不再详细分析，本文直接给出结果，读者可按照上述方法自行分析。后续的Java源码为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">StringBuilder sb1 = new StringBuilder(str1);</div><div class="line">sb1 = sb1.reverse();</div><div class="line">String str2 = sb1.toString();</div><div class="line">StringBuilder sb2 = new StringBuilder();</div><div class="line">String str3 = new String(d1);</div><div class="line">String str4 = str3.replace(&apos;S&apos;, &apos;e&apos;);</div><div class="line">String str5 = str4.replace(&apos;d&apos;, &apos;n&apos;);</div><div class="line">String str6 = str5.trim();</div><div class="line">StringBuilder sb3 = sb2.append(str6);</div><div class="line">StringBuilder sb4 = sb3.append(str2);</div><div class="line">String str7 = new String(s4);</div><div class="line">String str8 = str7.substring(2, 7);</div><div class="line">StringBuilder sb5 = sb4.append(str8);</div><div class="line">String str9 = sb5.toString();</div></pre></td></tr></table></figure></p>
<p>整合前面全部Java源码，最后得到获取Flag的Java代码为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">public String getFlag() &#123;</div><div class="line">    byte[] s1 = new byte[]&#123;0x78, 0x45, 0x78, 0x32, 0x57, 0x37&#125;;               // r10</div><div class="line">    byte[] s2 = new byte[]&#123;0x22, 0x29, 0x44, 0x55, 0x60, 0x33&#125;;               // r7</div><div class="line">    byte[] s3 = new byte[]&#123;0x17, (byte) 0x94, 0x35, 0x03, (byte) 0x90&#125;;                   // [sp, #56]</div><div class="line">    byte[] s4 = new byte[]&#123;0x45, 0x64, 0x5f, 0x41,0x52, 0x54, 0x7d&#125;;    // [sp, #60]</div><div class="line">    byte[] s5 = new byte[]&#123;0x58, 0x75, 0x1b, (byte) 0xf0, 0x0f, 0x4c&#125;;              // r11</div><div class="line">    byte[] s6 = new byte[]&#123;0x69, 0x0c, 0x1b, (byte) 0xbe, (byte) 0xf2, 0x49&#125;;         //[sp, #52]</div><div class="line"></div><div class="line">    for (int i = 0; i &lt; s2.length; ++i) &#123;</div><div class="line">        s2[i] = (byte) ((s2[i] + 54) ^ s6[i]);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    for (int i = 0; i &lt; s1.length; i++) &#123;</div><div class="line">        if (s1[i] == 87) &#123;</div><div class="line">            s1[i] = 105;</div><div class="line">        &#125;</div><div class="line">        if (s1[i] == 50) &#123;</div><div class="line">            s1[i] = ~(123);</div><div class="line">        &#125;</div><div class="line">        s1[i] = (byte) (s1[i] ^ s5[i]);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    byte[] d1 = new byte[s1.length + s2.length];    // [sp, #40]</div><div class="line">    System.arraycopy(s1, 0, d1, 0, s1.length);</div><div class="line">    System.arraycopy(s2, 0, d1, s2.length, s2.length);</div><div class="line"></div><div class="line">    s3[4] = (byte) (s3[4] - 49);</div><div class="line">    s3[3] = (byte) (s3[3] + 47);</div><div class="line">    s3[2] = (byte) (s3[2] + 42);</div><div class="line">    s3[1] = (byte) (s3[1] - 34);</div><div class="line">    s3[0] = (byte) (s3[0] + 46);</div><div class="line"></div><div class="line">    String str1 = new String(s3);</div><div class="line"></div><div class="line">    StringBuilder sb1 = new StringBuilder(str1);</div><div class="line">    sb1 = sb1.reverse();</div><div class="line">    String str2 = sb1.toString();</div><div class="line">    StringBuilder sb2 = new StringBuilder();</div><div class="line">    String str3 = new String(d1);</div><div class="line">    String str4 = str3.replace(&apos;S&apos;, &apos;e&apos;);</div><div class="line">    String str5 = str4.replace(&apos;d&apos;, &apos;n&apos;);</div><div class="line">    String str6 = str5.trim();</div><div class="line">    StringBuilder sb3 = sb2.append(str6);</div><div class="line">    StringBuilder sb4 = sb3.append(str2);</div><div class="line">    String str7 = new String(s4);</div><div class="line">    String str8 = str7.substring(2, 7);</div><div class="line">    StringBuilder sb5 = sb4.append(str8);</div><div class="line">    String str9 = sb5.toString();</div><div class="line"></div><div class="line">    return str9;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最后的Flag为：<code>0ctf{1ea5n_2_rE_ART}</code>。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://ele7enxxh.com/0ctf-2016-State-Of-The-ART-Writeup.html" data-id="cj0sqoprw0001q043bl7p7u0s" class="article-share-link">Share</a><div class="tags"></div><div class="post-nav"><a href="/Bctf-2016-LostFlower-Writeup.html" class="pre">bctf 2016 LostFlower writeup</a><a href="/0ctf-2016-Boomshakalaka-Writeup.html" class="next">0ctf 2016 boomshakalaka writeup</a></div><div id="disqus_thread"><script>var disqus_shortname = 'ele7enxxh';
var disqus_identifier = '0ctf-2016-State-Of-The-ART-Writeup.html';
var disqus_title = '0ctf 2016 State of the ART writeup';
var disqus_url = 'http://ele7enxxh.com/0ctf-2016-State-Of-The-ART-Writeup.html';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//ele7enxxh.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://ele7enxxh.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/Details-Of-Denial-Of-Service-Vulnerability-In-Mediaserver-CVE-2017-0497.html">Details of Denial of Service Vulnerability in Mediaserver (CVE-2017-0497)</a></li><li class="post-list-item"><a class="post-list-link" href="/Details-Of-Elevation-Of-Privilege-Vulnerability-In-Recovery-Verifier-CVE-2017-0475.html">Details of Elevation of Privilege Vulnerability in Recovery Verifier (CVE-2017-0475)</a></li><li class="post-list-item"><a class="post-list-link" href="/Use-AFL-For-Stagefright-Fuzzing-On-Linux.html">在Linux上使用AFL对Stagefright进行模糊测试</a></li><li class="post-list-item"><a class="post-list-link" href="/Details-Of-Elevation-Of-Privilege-Vulnerability-In-Libziparchive-CVE-2016-6762.html">Details of Elevation of Privilege Vulnerability in Libziparchive (CVE-2016-6762)</a></li><li class="post-list-item"><a class="post-list-link" href="/Use-AFL-dyninst-To-Fuzz-Blackbox-Binaries.html">使用afl-dyninst fuzz无源码的二进制程序</a></li><li class="post-list-item"><a class="post-list-link" href="/Bctf-2016-LostFlower-Writeup.html">bctf 2016 LostFlower writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/0ctf-2016-State-Of-The-ART-Writeup.html">0ctf 2016 State of the ART writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/0ctf-2016-Boomshakalaka-Writeup.html">0ctf 2016 boomshakalaka writeup</a></li><li class="post-list-item"><a class="post-list-link" href="/Android-Arm-Inline-Hook.html">Android Arm Inline Hook</a></li><li class="post-list-item"><a class="post-list-link" href="/Analysis-Of-Backtrace-And-Inline-Hook-Thread-Safety-On-The-ARM-Platform.html">ARM平台backtrace与inlineHook多线程安全浅析</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> Recent Comments</i></div><script type="text/javascript" src="//ele7enxxh.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Ele7enxxh's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e9925f9b47e12674b38b04ce3cde49e6";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>